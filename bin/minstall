#!/bin/sh
# minstall - Minimal installation script
#
# This replaces 'install' for two reasons:
# - Permissions are not to be modified such that the ACLs will inherit
#   properly.
# - If the existing file is equivalent, it will not be touched so that the
#   inode (used for E-Tag generation) is unchanged
#
# Parameters:
# -d    Create directories (uses mkdir without chown/chmod)
# -z    Compress files (uses gzip for Content-Encoding)

usage() {
cat >&2 <<__EOF__
Usage: $(basename $0) [-zv] file1 file2
       $(basename $0) [-zv] file1 ... fileN directory
       $(basename $0) -d [-v] directory
__EOF__
  exit 1
}

install() {
  # Don't update the file if nothing has changed (keep timestamp)
  if ! diff -q "$1" "$2" > /dev/null 2>&1; then
    cp ${VERBOSE} -- "$1" "$2" || return $?
    # Create or destroy the .gz file as appropriate
    if ${COMPRESS}; then
      gzip -9fk ${VERBOSE} "$2"
    else
      rm -f "$2".gz
    fi
  elif ${COMPRESS}; then
    # Create .gz file if it is missing
    if [ ! -f "$2".gz ]; then
      gzip -9fk ${VERBOSE} "$2"
    fi
  else
    # Delete .gz file if it is not to exist
    rm -f "$2".gz
  fi
}

MKDIR=false
COMPRESS=false
VERBOSE=
umask 002

while getopts dhvz OPT; do
  case ${OPT} in
  d) MKDIR=true ;;
  v) VERBOSE=-v ;;
  z) COMPRESS=true ;;
  *) usage ;;
  esac
done
shift $((OPTIND-1))

if ${MKDIR}; then
  # Directory creation mode
  [ $# -gt 0 ] || usage
  # Just use mkdir since it won't attempt to change permissions
  mkdir -p ${VERBOSE} -- "$@"
else
  # File installation mode
  eval DEST="\${$#}"
  [ $# -gt 1 -a -n "${DEST}" ] || usage
  if [ -d "${DEST}" ]; then
    # Destination is a directory
    RESULT=0
    while [ $# -gt 1 ]; do
      install "$1" "${DEST}/$(basename $1)" || RESULT=1
      shift
    done
    exit ${RESULT}
  else
    # Destination is a file
    if [ $# -ne 2 ]; then
      echo "$(basename $0): target directory '${DEST}' does not exist" >&2
      usage
      exit 1
    fi
    install "$1" "$2"
  fi
fi
